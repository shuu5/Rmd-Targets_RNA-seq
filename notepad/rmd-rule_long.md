# R Markdownとtargetsを用いたRNA-seq解析パイプライン構築ガイドライン (AI 指針)

## 1. 基本方針: `targets` による自動化と再現性
このガイドラインは、RNA-seq解析のための**R Markdown (Rmd) モジュール**と **`targets` パッケージ**を用いたパイプラインをAI (あなた) が構築する際の**共通ルール**です。あなたは、このルールと個別の**モジュール仕様書**に基づき、再現性と効率性の高いパイプライン定義ファイル (`_targets.R`) と Rmd モジュールを作成します。

**最重要原則:**
- パイプライン全体の制御は `targets` で行う。
- **すべての解析ステップ (SE オブジェクト作成を含む) は Rmd モジュールとして実装する (`tar_render` を利用)。**
- データフローの中心は `SummarizedExperiment` (SE) オブジェクトとする。
- SE オブジェクトのメタデータ (`metadata()`) に解析履歴を記録し、パイプライン制御に活用する。

## 1.2. ターゲットとオブジェクトの命名規則
パイプライン内のターゲットとオブジェクトを明確に区別するため、以下の命名規則を採用します。

### 1.2.1. 基本プレフィックス
すべてのターゲット名に、その種類を示す**プレフィックス**を付けます：

- **`obj_`**: データオブジェクト（SummarizedExperiment等）
  - 例: `obj_se_raw`, `obj_se_normalized`
- **`rmd_`**: Rmdモジュールのレンダリング結果
  - 例: `rmd_create_se`, `rmd_quality_check`
- **`rep_`**: レポートファイル（HTML等）
  - 例: `rep_qc_report`, `rep_de_analysis`
- **`plt_`**: プロット（図表）
  - 例: `plt_pca`, `plt_heatmap_de`
- **`tbl_`**: テーブル（表）
  - 例: `tbl_de_genes`, `tbl_pathway`
- **`utl_`**: ディレクトリ作成などのユーティリティターゲット
  - 例: `utl_setup`

### 1.2.2. 命名パターン
基本的な命名パターンは `[プレフィックス]_[内容]_[状態/段階]` とします：

- **内容**: 何のデータ/処理かを表す（`se`, `counts`, `de`, `pca`など）
- **状態/段階**: 処理段階や状態を表す（`raw`, `filtered`, `normalized`など）

### 1.2.3. 例示
以下は命名例です：

- **SEオブジェクト**: 
  - `obj_se_raw` (生データからのSE)
  - `obj_se_filtered` (フィルタリング後のSE)
  - `obj_se_normalized` (正規化後のSE)

- **Rmdモジュール**:
  - `rmd_create_se` (SEオブジェクト作成モジュール)
  - `rmd_filter_se` (SEフィルタリングモジュール)
  - `rmd_normalize_se` (SE正規化モジュール)

- **レポート**:
  - `rep_qc_initial` (初期品質管理レポート)
  - `rep_de_results` (DE解析結果レポート)

### 1.2.4. 命名規則の一貫性
- パイプライン全体で命名規則を一貫して適用する
- 特に関連するターゲット間では命名パターンを統一する
  - 例: `obj_se_normalized` と `rmd_normalize_se` は関連する処理を示す
- ターゲット名は`experiment_id`に依存しない汎用的な名前とする

## 1.3. 推奨ディレクトリ構成
`experiment_id`は解析対象の実験を識別するIDです。以下の主要ディレクトリを用意します。

- **`_targets.R`**: パイプラインのターゲット定義と依存関係を記述するファイル
- **`Rmd/`**: 各解析ステップのRmdモジュールを格納
- **`data/{experiment_id}/`**: 実験ごとの入力データを格納
- **`results/{experiment_id}/`**: 実験ごとの出力結果を格納（plots/, tables/, reports/サブディレクトリを推奨）
- **`logs/{experiment_id}/`**: 実験ごとのログファイルを格納
- **`config.yaml`**: パイプライン設定ファイル（必須）
- **`spec/`**: モジュール仕様書を格納
- **`tests/`**: Rmdモジュールのユニットテスト
- **`renv/`, `renv.lock`**: パッケージ管理
- **`R/`**: 共通ユーティリティ関数など(`utility.R`など)を格納

**重要:** ファイルパスは原則として`fs::path_abs()`を用いて絶対パスで指定する。

## 2. データフロー: SE オブジェクトと `targets`
- **入力:**
    - **実験 ID (`experiment_id`):** パイプライン実行時に指定される、解析対象の実験を識別する ID。
    - **最初の Rmd モジュール (SE オブジェクト作成):** `experiment_id` に基づいて、対応する `counts.csv` や `sample_metadata.csv` 等 (例: `data/{experiment_id}/counts.csv`) を入力とし、SE オブジェクトを生成する `tar_render` ターゲットを定義する。
    - **後続 Rmd モジュール:** 前のステップで生成/更新された SE オブジェクトを**入力ターゲット**とする。
- **処理:** 各 Rmd モジュールは入力 SE オブジェクトを受け取り、解析処理を行い、更新された SE オブジェクトを**出力ターゲット**として返す。
- **メタデータ記録:** 各 Rmd モジュールは、実行した主要な処理内容、パラメータ、完了日時などを **`metadata(se)$pipeline_history`** のようなリスト構造に追記する。これは `targets` の依存関係とは別に、オブジェクト自体に処理履歴を持たせるため。 (SE オブジェクトのメタデータに `experiment_id` を含めることも検討可能)
- **パイプライン制御:** `_targets.R` 内で、ターゲット定義の際に SE オブジェクトのメタデータ情報を条件分岐 (`if` 文など) に利用することを検討する (例: 特定のアノテーションが付与されている場合のみ実行)。**ファイルパスは原則としてプロジェクトルートからの絶対パスで指定する (`fs::path_abs()` を利用)。**

## 3. コーディング規約 (`_targets.R` と Rmd モジュール)

### 3.1. ロギングルール

#### 3.1.1. 基本方針
- パイプライン実行状況の追跡と再現性向上のため、**`futile.logger`によるログ記録を必須とする**
- ログはログファイル(`logs/{experiment_id}/`)にのみ出力し、**レンダリング出力(HTML/MD)には表示しない**
- ログ出力と解析結果表示は明確に分離する（Rmdチャンクの`include=FALSE`オプションを使用）

#### 3.1.2. ログ設定と階層
- **ログレベル:** TRACE(最詳細) < DEBUG < INFO < WARN < ERROR < FATAL(最重大)
- **出力制御:** 基本は`_targets.R`で`flog.threshold(INFO)`で一元管理、Rmdでは`TRACE`レベルまで記録
- **ログフォーマット:** `[タイムスタンプ] [ログレベル] [識別子] メッセージ`
- **ファイル名:** `logs/{experiment_id}/_targets.log`, `logs/{experiment_id}/{Rmdファイル名}.log`

#### 3.1.3. `_targets.R`でのロギング
- パイプライン開始時に`futile.logger`を設定し、ログディレクトリを確保
- `experiment_id`確定、設定値読み込み、ターゲット実行開始/終了を`INFO`レベルで記録
- ファイルパスは絶対パス(`fs::path_abs()`)で記述

#### 3.1.4. Rmdモジュールでのロギング
- セットアップチャンクでロガー設定（必ず`include=FALSE`）
- ログ出力と解析コード/結果表示を分離:
  - ログ出力: `include=FALSE`チャンクに記述
  - 解析結果表示: 通常の`include=TRUE`チャンクに記述
- ログレベルの使い分け:
  - **TRACE/DEBUG:** 変数値、詳細な処理過程
  - **INFO:** 主要ステップの開始/終了、重要パラメータ
  - **WARN/ERROR:** 問題発生や警告（欠損値、外れ値検出など）
- 記録すべき情報: 入出力オブジェクト、主要処理ステップ、SEメタデータ更新内容、エラー/警告

#### 3.1.5. レンダリング出力設定
- YAMLフロントマターで出力形式を設定（例: HTML, コード折りたたみなど）
- チャンクオプション`message=FALSE`, `warning=FALSE`で表示メッセージを制御
- 重要な警告は適宜レポートに含める判断をする

### 3.2. その他のコーディング規約

### 3.3. 共通ユーティリティ関数の使用

#### 3.3.1. 基本方針
- **コード重複回避:** Rmdモジュール間で共通する関数は`R/utility.R`にまとめ、コードの重複を避ける
- **ユーティリティの範囲:** 解析の本質的な部分ではなく、サポート機能（ロギング、履歴記録など）を中心に提供する
- **一貫性維持:** すべてのモジュールで同じユーティリティ関数を使用し、動作の一貫性を確保する

#### 3.3.2. 利用可能なユーティリティ関数の確認
- **直接参照:** 利用可能なユーティリティ関数は`R/utility.R`ファイルを直接参照して確認する
- **仕様確認:** 各関数の詳細な仕様と使用方法は`spec/utility_spec.md`を参照する
- **提供機能:** 基本的なロギング機能（`setup_logger`）やSEオブジェクトのメタデータ管理機能（`record_pipeline_history`）などが提供されている

#### 3.3.3. ユーティリティ関数の使用ルール
- **明示的な呼び出し:** 各Rmdモジュールでは、ユーティリティ関数を明示的に呼び出す（`source()`は原則使用しない）
- **ライブラリ読み込み:** ユーティリティ関数だけでなく、必要なパッケージも各モジュールで明示的に読み込む
- **標準パターン:** 各Rmdモジュールでは、最新の`R/utility.R`で提供される関数に基づいて適切なパターンで使用する
  ```r
  # セットアップチャンク (include=FALSE)で:
  library(futile.logger)
  library(fs)
  library(here)
  
  # 現在R/utility.Rで提供されているロガー設定関数を使用
  logger_settings <- setup_logger("[module_name]", params$experiment_id)
  futile.logger::flog.appender(logger_settings$appender)
  futile.logger::flog.layout(logger_settings$layout)
  futile.logger::flog.threshold(logger_settings$threshold)
  
  # ...処理内容...
  
  # 現在R/utility.Rで提供されている履歴記録関数を使用
  se <- record_pipeline_history(se, "[module_name]", "[description]", params)
  ```

#### 3.3.4. 新規ユーティリティ関数の追加
- **実装場所:** 新たなユーティリティ関数は`R/utility.R`に追加する
- **仕様書の更新:** 追加した関数の仕様を`spec/utility_spec.md`に必ず追記する
- **適用範囲:** 複数のRmdモジュールで共通利用される関数のみをユーティリティとする
- **関数設計:** 単一責任の原則に従い、明確な入出力仕様を持つ関数として設計する

## 4. スタイルとテスト
- **スタイル:** Tidyverse スタイル + Bioconductor コーディング規約。
- **コメント言語:** **コード内のコメントは原則として日本語で記述する。**
- **テスト (TDD):** **Rmd モジュール**を実装する際は、以下の **Red-Green-Refactor サイクル**を厳守してください:
    1.  **Red:** まず失敗する最小限のテストコードを `testrmd` で記述します (`tests/test-{Rmdファイル名}.R` などに配置)。
    2.  **Green:** そのテスト (`testrmd::test_rmd()`) をパスする最小限のコードを Rmd モジュール内に実装します。
    3.  **Refactor:** テストが通る状態を維持しつつ、Rmd モジュール内のコードをリファクタリングします。
    - テスト記述には `testrmd` パッケージの関数 (`test_rmd()`, `extract_chunks()` など) を使用します。テストの実行は `_targets.R` 内で管理することも検討できます。

## 5. 再現性とパッケージ管理
- **再現性:** `targets` が依存関係とキャッシュを管理し、再現性を担保する。
- **パッケージ管理:** `renv` を使用する。`renv::snapshot()` で `renv.lock` を更新。`_targets.R` や Rmd の冒頭で必要な `library()` を記述。`sessionInfo()` は `tar_render` で生成されるレポートに含める。

## 6. モジュール仕様書 (AI 向け指示)
各 **Rmd モジュール**作成を指示する際は、以下の**ターゲット定義情報**を含む**仕様書**を提示してください。
- **ターゲット名:** `experiment_id` に依存しない汎用的な名前を基本とする
- **目的:** このターゲットがパイプラインで果たす役割
- **入力ターゲット:**
    - 依存するターゲット名
    - 期待される入力 SE オブジェクトの状態
    - その他の入力ファイルやパラメータ
- **実行コマンド/処理:**
    - 関連する Rmd ファイル名
    - 主要な処理ステップ、アルゴリズム、主要パッケージ/関数
    - 使用する主要パラメータ（`experiment_id`は`params`で渡す）
    - SE オブジェクトのメタデータ更新ロジック
    - ログ出力設定
- **必須ロギング要件:**
    - 使用するロガー名
    - 記録すべき主要な情報
    - ログレベルの使い分け
- **出力ターゲット:**
    - 生成されるオブジェクト名
    - 更新後の SE オブジェクトの期待される状態
    - 生成されるファイルの命名規則と保存場所
- **レポート要件:** 含めるべき図表、統計情報、テキスト概要
- **その他:** エラーハンドリング、特別な制約など

## 7. パイプライン構成 (`_targets.R`)
- **モジュール実行順序:** `_targets.R` 内のターゲット間の依存関係で定義する。ファイル名は可読性の補助として意味のある名前を使用する。
- **パイプラインの柔軟性:** `_targets.R` を修正することで、モジュールの組み合わせ変更や条件分岐による実行制御を行う。**`experiment_id` を変更して再実行することで、異なる実験データに対して同じ解析フローを適用できる。**

## 8. 可視化とレポート
- **標準パッケージ:** `ggplot2`, `pheatmap`, `ComplexHeatmap`, `RColorBrewer`, `viridis`

- **プロットの標準スタイル:**
  - **テーマ:** `theme_classic()`を基本とし、プロットタイトルは中央寄せ
  - **言語:** プロット内のテキストはすべて英語（レポート本文は日本語可）
  - **ファイル形式:** 基本はPNG、長大なプロットはPDF、対話的プロットはHTML
  - **命名規則:** `{プロットタイプ}_{データタイプ}_{条件}.{拡張子}`
  - **保存場所:** `results/{experiment_id}/plots/`ディレクトリ
  - **サイズ・解像度:** レポート表示に適したサイズと解像度（300dpi以上推奨）

- **プロット生成管理:**
  - 重要なプロット生成ロジックはRmdチャンク内に記述
  - パイプライン実行時に自動生成されるようにtargetsターゲットとして定義
  - プロット生成時には`futile.logger`でログを残す

### 8.1. Rmdモジュールの共通出力設定
- **出力設定の一元管理:** すべてのRmdモジュールの出力形式設定は`_targets.R`で一元管理する。
- **標準出力設定:** 特に明示されない限り、以下の標準設定を適用する:
  ```r
  # _targets.Rでの標準出力設定定義
  rmd_output_format <- rmarkdown::html_document(
    toc = TRUE,            # 目次を表示
    toc_float = TRUE,      # 浮動目次
    code_folding = "hide", # コードは初期状態で折りたたむ
    keep_md = TRUE         # Markdown形式も保持
  )
  ```
- **適用方法:** 各`tar_render`呼び出しで`output_format`パラメータに上記の設定を指定する:
  ```r
  tar_render(
    target_name,
    "path/to/module.Rmd",
    params = list(experiment_id = experiment_id),
    output_format = rmd_output_format  # 共通設定を適用
  )
  ```
- **設定のカスタマイズ:** 特定のモジュールが異なる出力設定を必要とする場合は、モジュール仕様書で明示的に指定する。
