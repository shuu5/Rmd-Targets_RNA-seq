# R Markdownとtargetsを用いたRNA-seq解析パイプライン構築ガイドライン (AI 指針)

## 1. 基本方針: `targets` による自動化と再現性
このガイドラインは、RNA-seq解析のための**R Markdown (Rmd) モジュール**と **`targets` パッケージ**を用いたパイプラインをAI (あなた) が構築する際の**共通ルール**です。あなたは、このルールと個別の**モジュール仕様書**に基づき、再現性と効率性の高いパイプライン定義ファイル (`_targets.R`) と Rmd モジュールを作成します。

**最重要原則:**
- パイプライン全体の制御は `targets` で行う。
- 解析ステップは Rmd モジュールとして実装する (`tar_render` を利用)。
- データフローの中心は `SummarizedExperiment` (SE) オブジェクトとする。
- SE オブジェクトのメタデータ (`metadata()`) に解析履歴を記録し、パイプライン制御に活用する。

## 1.1. 推奨ディレクトリ構成
以下に推奨されるディレクトリ構造の例を示します。`experiment_id` は解析対象の実験を識別するIDです。

```
your-project-root/
├── _targets.R             # targets パイプライン定義ファイル
├── _targets/              # targets キャッシュとメタデータ (自動生成)
├── config.yaml            # パイプライン設定ファイル (例: experiment_id 指定)
├── R/                   # R 関数 (再利用可能なスクリプト)
│   └── Rxx_*.R            # 例: R01_se_creation.R, R02_utils.R
├── Rmd/                   # R Markdown モジュール (各解析ステップ)
│   └── RMDxx_*.Rmd        # 例: RMD01_qc_report.Rmd, RMD02_normalization.Rmd
├── data/                  # 入力データ (experiment_id ごとにサブディレクトリ化)
│   └── {experiment_id}/   # 例: data/ExpA/
│       ├── counts.csv
│       └── sample_metadata.csv
├── results/               # 出力結果 (experiment_id ごとにサブディレクトリ化)
│   └── {experiment_id}/   # 例: results/ExpA/
│       ├── plots/         # プロット
│       ├── tables/        # テーブル
│       └── reports/       # レンダリングされた Rmd レポート
├── spec/                  # モジュール仕様書
│   └── *_spec.md
├── tests/                 # ユニットテスト (testthat)
├── notepad/               # ルール、テンプレート、メモ
├── logs/                  # ログファイル (experiment_id ごとにサブディレクトリ化)
│   └── {experiment_id}/   # 例: logs/ExpA/
├── renv/                  # renv 環境ファイル
├── renv.lock              # renv ロックファイル
├── .Rprofile              # R セッション起動スクリプト (renv 読み込み等)
├── .cursor/               # Cursor 設定ファイル (オプション)
├── .gitignore
└── README.md
```

**主要ディレクトリの説明:**

*   **`_targets.R`**: パイプラインのターゲット定義と依存関係を記述する中心ファイル。
*   **`R/`**: `_targets.R` や Rmd モジュールから呼び出す共通 R 関数 (`.R`) を格納。ファイル名は `Rxx_*.R` (連番 `xx` と内容を示す名前) を推奨。
*   **`Rmd/`**: 解析ステップごとの R Markdown モジュール (`.Rmd`) を格納。ファイル名は `RMDxx_*.Rmd` (連番 `xx` と内容を示す名前) を推奨。実行順序は `_targets.R` で定義される。
*   **`data/{experiment_id}/`**: **`experiment_id` ごとに** サブディレクトリを作成し、その実験に対応する入力データ (カウント、メタデータ等) を格納。`_targets.R` 内で `sprintf("data/%s/counts.csv", experiment_id)` のように動的にパスを生成するが、**最終的に関数やレンダリングプロセスに渡されるパスは `fs::path_abs()` を用いて絶対パスに変換することを推奨する。**
*   **`results/{experiment_id}/`**: **`experiment_id` ごとに** サブディレクトリを作成し、生成されたプロット、テーブル、レポート等を格納。`_targets.R` や Rmd 内で `sprintf("results/%s/plots/pca.png", experiment_id)` のように動的にパスを生成し、**最終的に `fs::path_abs()` を用いて絶対パスに変換することを推奨する。** サブディレクトリ (`plots/`, `tables/`, `reports/`) で整理することを推奨。
*   **`logs/{experiment_id}/`**: **`experiment_id` ごとに** サブディレクトリを作成し、Rmd レンダリング時のログファイルなどを格納する。
*   **`config.yaml`**: **必須ファイル。**`experiment_id` など、パイプライン全体に関わる設定値を管理する。
*   **`spec/`**: 各 `R` 関数や `Rmd` モジュールの仕様書 (`_spec.md`) を格納。
*   **`tests/`**: `R/` 関数のユニットテストを格納 (`testthat` を使用)。
*   **`renv/`, `renv.lock`, `.Rprofile`**: `renv` によるパッケージ管理。

## 2. データフロー: SE オブジェクトと `targets`
- **入力:**
    - **実験 ID (`experiment_id`):** パイプライン実行時に指定される、解析対象の実験を識別する ID。
    - **最初のモジュール (SE オブジェクト作成):** `experiment_id` に基づいて、対応する `counts.csv` や `sample_metadata.csv` 等 (例: `data/{experiment_id}/counts.csv`) を入力とし、SE オブジェクトを生成するターゲットを定義する。
    - **後続モジュール:** 前のステップで生成/更新された SE オブジェクトを**入力ターゲット**とする。
- **処理:** 各モジュールは入力 SE オブジェクトを受け取り、解析処理を行い、更新された SE オブジェクトを**出力ターゲット**として返す。
- **メタデータ記録:** 各モジュールは、実行した主要な処理内容、パラメータ、完了日時などを **`metadata(se)$pipeline_history`** のようなリスト構造に追記する。これは `targets` の依存関係とは別に、オブジェクト自体に処理履歴を持たせるため。 (SE オブジェクトのメタデータに `experiment_id` を含めることも検討可能)
- **パイプライン制御:** `_targets.R` 内で、ターゲット定義の際に SE オブジェクトのメタデータ情報を条件分岐 (`if` 文など) に利用することを検討する (例: 特定のアノテーションが付与されている場合のみ実行)。**ファイルパスは原則としてプロジェクトルートからの絶対パスで指定する (`fs::path_abs()` を利用)。**

## 3. コーディング規約 (`_targets.R` と Rmd)

**全般: ロギング**
- パイプラインの実行状況の追跡、デバッグ、再現性向上のため、**`futile.logger` を用いたロギングを必須とする。**
- ログは、パイプライン全体の流れ、各ステップの開始/終了、主要なパラメータ、処理されたデータ、発生したエラーなどを記録する。
- **ログ設定:**
    - **パッケージ:** `futile.logger` を使用する。
    - **出力先ディレクトリ:** `logs/{experiment_id}/`。このディレクトリは `_targets.R` の初期段階で `fs::dir_create()` を用いて確実に作成するターゲット (`ensure_log_dir` など) を設ける。
    - **ログファイル名:**
        - `_targets.R` 全体の実行ログ: `_targets.log` (例: `logs/ExpA/_targets.log`)
        - Rmd モジュール (`Rmd/RMDxx_*.Rmd`): `RMDxx_*.log` (例: `logs/ExpA/RMD01_qc_report.log`)
        - R 関数 (`R/Rxx_*.R`) 呼び出し時の専用ログ (必要な場合): `Rxx_*.log` (例: `logs/ExpA/R01_create_se.log`) - 基本的には `_targets.log` または呼び出し元 Rmd のログに出力する。
    - **ログレベル:** 基本は `INFO` レベルとする。`flog.threshold(INFO)`。デバッグ時には `DEBUG` レベルの出力も有効にする (`flog.threshold(DEBUG)`) ことを考慮する。
    - **ログフォーマット:** `[タイムスタンプ] [ログレベル] [呼び出し元識別子] メッセージ` を推奨。
        - `_targets.R` では、`flog.layout(layout.format('[%t] [%l] [_targets.R] %m'))` のように設定。
        - Rmd や R 関数内では、ファイル名や関数名を識別子として設定する (例: `layout.format('[%t] [%l] [RMD01_qc_report] %m')`)。
    - **アペンダー:** 主に `appender.file()` を使用し、指定されたログファイルに出力する。コンソールにも同時に出力したい場合は `appender.tee()` を使用する。

- **`_targets.R` におけるロギング:**
    - **必須:** パイプライン開始時に `futile.logger` の設定（ルートロガーの閾値、レイアウト、アペンダー設定で `logs/{experiment_id}/_targets.log` へ出力）を行う。
    - ログディレクトリ (`logs/{experiment_id}/`) が存在しない場合に作成するターゲット (`ensure_log_dir`) を定義し、他のログ出力ターゲットがこれに依存するようにする。
    - `experiment_id` の確定、主要な設定値の読み込みを `INFO` レベルで記録する。
    - 各ターゲットの実行開始/終了（特に時間のかかる処理や重要なステップ）を `INFO` レベルで記録する。
    - `tar_render` や R 関数呼び出しの際には、呼び出す Rmd ファイル名や関数名、渡す主要なパラメータを `INFO` レベルで記録する。
    - パイプライン全体の開始と終了、成功/失敗ステータスを記録する。
    - **ファイルパス:** 原則として絶対パス (`fs::path_abs()`) を使用する。
    - **その他:** 必要に応じて `DEBUG` レベルで詳細な情報を記録する。

- **Rmd モジュール (`Rmd/RMDxx_*.Rmd`) におけるロギング:**
    - **必須:** Rmd ファイル冒頭のセットアップチャンク (`setup`) で、`futile.logger` を用いたロガーを設定する。
        - **ロガー名:** Rmd ファイル名に基づいて設定 (例: `flog.logger("RMD01_qc_report")`)。
        - **出力ファイル:** `logs/{experiment_id}/{Rmdファイル名}.log` を指定する。`params$exp_id` を利用してパスを組み立て、`fs::path_abs()` で絶対パスに変換する。
        - **レイアウト:** 上記推奨フォーマットに従い、識別子を Rmd ファイル名にする。
        - **閾値:** デフォルト `INFO`。
        - **アペンダー:** `appender.file()` を設定。
    - **必須:** `tar_load()` や `tar_read()` で読み込んだ主要なオブジェクト名やファイルパスを `INFO` レベルで記録する。
    - **必須:** 主要な処理ステップ（フィルタリング、正規化、可視化など）の開始と終了、使用した主要パラメータを `INFO` レベルで記録する。
    - **必須:** 生成した主要な出力ファイル（プロット、テーブル）のパスを `INFO` レベルで記録する。
    - **必須:** SE オブジェクトのメタデータ更新内容を `INFO` レベルで記録する。
    - `cli` でユーザー向けメッセージを出力するのは良いが、**実行記録としてのログは `futile.logger` で行うこと。**
    - 必要に応じて、計算の中間結果やデバッグに役立つ変数の値を `DEBUG` レベルで記録する。

- **共通関数 (`R/Rxx_*.R`) におけるロギング:**
    - **推奨:** 関数が呼び出されたこと、主要な引数の値を `INFO` または `DEBUG` レベルで記録する。
    - **推奨:** 関数内の主要な処理分岐や、時間のかかる可能性のあるループ処理の開始/終了を記録する。
    - **推奨:** エラーハンドリング (`tryCatch` など) 内で、エラー発生時に詳細な情報を `ERROR` レベルで記録する。
    - **注意:** 関数内でロガー設定 (アペンダーやレイアウト) を変更せず、呼び出し元 (`_targets.R` や Rmd) で設定されたロガー (`flog.info()`, `flog.warn()`, `flog.error()` など) を直接使用する。
    - 関数の仕様は `spec/` 内の対応する仕様書 (`*_spec.md`) で管理。

## 4. スタイルとテスト
- **スタイル:** Tidyverse スタイル + Bioconductor コーディング規約。
- **コメント言語:** **コード内のコメントは原則として日本語で記述する。**
- **テスト (TDD):** 共通関数や複雑な解析ロジックなど、テスト駆動開発が推奨される関数を実装する際は、以下の **Red-Green-Refactor サイクル**を厳守してください:
    1.  **Red:** まず失敗する最小限のテストコードを `testthat` で記述します。
    2.  **Green:** そのテストをパスする最小限のプロダクションコードを実装します。
    3.  **Refactor:** テストが通る状態を維持しつつ、コードをリファクタリングします。
    - テスト記述には `testthat::test_that()` と `expect_*()` 関数を使用します。

## 5. 再現性とパッケージ管理
- **再現性:** `targets` が依存関係とキャッシュを管理し、再現性を担保する。
- **パッケージ管理:** `renv` を使用する。`renv::snapshot()` で `renv.lock` を更新。`_targets.R` や Rmd の冒頭で必要な `library()` を記述。`sessionInfo()` は `tar_render` で生成されるレポートに含める。

## 6. モジュール仕様書 (AI 向け指示)
各モジュール作成を指示する際は、以下の**ターゲット定義情報**を含む**仕様書**を提示してください。
- **ターゲット名:** (例: `se_filtered`, `report_qc`) `experiment_id` に依存しない汎用的な名前を基本とする。
- **目的:** このターゲットがパイプラインで果たす役割。
- **入力ターゲット:**
    - 依存するターゲット名。
    - 期待される入力 SE オブジェクトの状態 (必要な assays, colData, rowData, **metadata 内の履歴情報**)。**`experiment_id` に対応するデータであること。**
    - その他の入力ファイルやパラメータ (**`experiment_id` に基づいて `data/{experiment_id}/` 以下のパスが決定されることを明記**)。
- **実行コマンド/処理:**
    - Rmd ファイルのレンダリング (`tar_render`) か、関数の実行か。
    - **関連する Rmd ファイル名:** `RMDxx_*.Rmd` (Rmd の場合)
    - **関連する R 関数ファイル名:** `Rxx_*.R` (関数の場合)
    - 主要な処理ステップ、アルゴリズム、主要パッケージ/関数。
    - 使用する主要パラメータ (デフォルト値、ユーザー変更可否)。**Rmd の場合は `experiment_id` を `params` で渡すこと。**
    - **SE オブジェクトのメタデータ更新ロジック**。
    - **ログ出力:** Rmd レンダリングの場合、**`logs/{experiment_id}/` ディレクトリ下にログファイルを出力する設定を含めることを推奨。** ファイル名は Rmd ファイル名に対応させる (例: `logs/{experiment_id}/RMD01_qc_report.log`)。
- **必須ロギング要件:**
    - 使用するロガー名 (例: `RMD01_qc_report`)。
    - 記録すべき主要な情報: 入力オブジェクト/ファイル、主要パラメータ、実行ステップの開始/終了、出力ファイルパス、SE メタデータ更新内容。
    - ログレベルの使い分け (INFO, DEBUG)。
- **出力ターゲット:**
    - 生成されるオブジェクト名 (主に更新された SE オブジェクト)。
    - **更新後の SE オブジェクトの期待される状態** (追加/変更される assays, colData, rowData, **metadata の追記内容**)。
    - 生成されるファイル (プロット、テーブル) のリスト、命名規則、保存場所。**ファイル名やパスに `experiment_id` を含め、`results/{experiment_id}/` 以下に絶対パスで保存することを推奨** (例: `fs::path_abs(sprintf("results/%s/plots/pca.png", experiment_id))`)。
- **レポート要件 (Rmd の場合):** 含めるべき図表、統計情報、テキスト概要。
  - Rmd レポートの出力形式やオプションは、Rmd ファイル自身の YAML フロントマターで設定することを推奨します。以下に HTML と GitHub Flavored Markdown (.md) の両方を出力する際の推奨設定例を示します。

    ```yaml
    ---
    title: "レポートタイトル (実験ID: `r params$exp_id`)"
    output:
      html_document:
        toc: true          # 目次を表示
    params:
      exp_id: NA       # _targets.R から渡される実験ID
    ---
    ```

  - レポートタイトルや本文中に `experiment_id` (`r params$exp_id`) を含めることを強く推奨します。

- **その他:** エラーハンドリング、特別な制約、**ロガー設定は呼び出し元 (`_targets.R` または Rmd セットアップチャンク) で行われる想定であること**など。

## 7. パイプライン構成 (`_targets.R`)
- **モジュール実行順序:** `_targets.R` 内のターゲット間の依存関係で定義する。Rmd ファイル名のプレフィックス (`RMDxx_`) は可読性の補助として使用可。
- **パイプラインの柔軟性:** `_targets.R` を修正することで、モジュールの組み合わせ変更や条件分岐による実行制御を行う。**`experiment_id` を変更して再実行することで、異なる実験データに対して同じ解析フローを適用できる。**

## 8. 可視化とレポート
- **標準パッケージ:** 
  - プロット: `ggplot2`
  - ヒートマップ: `pheatmap`, `ComplexHeatmap`
  - 配色: `RColorBrewer`, `viridis`

- **プロットの標準スタイル:**
  - **テーマ:** `theme_classic()` をできるだけ使用する。必要に応じて独自のテーマ関数を作成し、一貫性を保つ。
  - **言語:** プロット内のラベル、タイトル、凡例等は**すべて英語**で記述する。**重要:** レポート本文は日本語でも構わないが、図表内のテキストは英語に統一する。
  - **ファイル形式:**
    - 基本: PNG形式 (`ggsave(..., width=7, height=5, dpi=300)`)
    - ヒートマップなど縦または横に極端に長いプロット: PDF形式で出力 (`ggsave(..., device=cairo_pdf)` または `pdf()` + `dev.off()`)
    - 対話的プロット: HTML形式 (`plotly`, `htmlwidgets` 等)
  - **命名規則:** `{プロットタイプ}_{データタイプ}_{条件}.{拡張子}` (例: `pca_normalized_top500var.png`, `heatmap_degs_treatment.pdf`)
  - **保存場所:** `results/{experiment_id}/plots/` ディレクトリ (絶対パスで指定)
  - **サイズ・解像度:** レポートに適切に表示されるサイズを考慮し、十分な解像度を確保する (例: 300dpi以上)。

- **プロット生成と管理:**
  - 重要なプロットは独立した関数として実装し、再利用可能にする。
  - パイプライン実行時に自動生成されるように `targets` ターゲットとして定義する。
  - 各プロットの生成時には `futile.logger` でログを残す。
  - 大きなサイズのプロット (特にPDF) は、必要に応じて圧縮または分割を検討する。
