# {module_name} モジュール仕様書

## ターゲット情報

### ターゲット名
`{target_name}` （`experiment_id` に依存しない汎用的な名前を基本とする）

### 目的
このモジュールは [モジュールの主な目的と役割を記述してください]。

### 入力ターゲット
- **依存ターゲット名**: `{input_target_name}` （例: `se_raw`, `se_filtered`）
- **SE オブジェクトの期待状態**:
  - **assays**: [必要な assay マトリックスを記述]
  - **colData**: [必要なサンプルメタデータ列を記述]
  - **rowData**: [必要な遺伝子/特徴量メタデータ列を記述]
  - **metadata**: [必要なメタデータ項目、特に pipeline_history 内の情報を記述]
- **その他の入力ファイル**:
  - [experiment_id に基づいて data/{experiment_id}/ 以下のパスが決定される場合はそれを記述]
  - [その他の入力ファイルやリソースがあれば記述]

### 実行コマンド/処理
- **関連する Rmd ファイル名**: `Rmd/{module_name}.Rmd`
- **主要な処理ステップ**:
  1. [主な処理ステップ1を記述]
  2. [主な処理ステップ2を記述]
  3. [以下、必要に応じて追加]
- **主要なパッケージ/関数**:
  - [使用する主要なパッケージや関数を記述]
- **主要パラメータ**:
  - `params$exp_id`: 実験ID (必須)
  - `params$module_name`: モジュール名 (必須)
  - `params$input_se`: 入力SEオブジェクトのターゲット名 (必須)
  - [その他のパラメータがあれば記述]
- **SE オブジェクトのメタデータ更新**:
  - `metadata(se)$pipeline_history[[{module_name}]]` に以下の情報を記録:
    - `module_name`: モジュール名
    - `execution_time`: 実行日時
    - `parameters`: 使用したパラメータ
    - `results`: [記録すべき主要な結果を記述]

### 必須ロギング要件
- **ロガー名**: `{module_name}`
- **ログファイル**: `logs/{experiment_id}/{module_name}.log`
- **ログ設定**:
  - セットアップチャンクでロガー設定（必ず`include=FALSE`に設定）
  - `futile.logger`パッケージを使用
  - ログはファイルにのみ出力し、レンダリング出力には表示しない
- **ログレベル**:
  - `TRACE`: 詳細な変数値、処理過程
  - `DEBUG`: デバッグに必要な情報
  - `INFO`: 基本的な進行状況、パラメータ、結果
  - `WARN`: 問題や警告（欠損値、外れ値検出など）
  - `ERROR`: エラー発生時の情報
- **記録すべき主要情報**:
  - 入力SEオブジェクトの基本情報 (サンプル数、遺伝子数)
  - 主要処理ステップの開始と終了
  - 使用した主要パラメータ値
  - 生成したプロット/テーブルのファイルパス
  - SEオブジェクトのメタデータ更新内容

## 出力情報

### 出力ターゲット
- **生成されるオブジェクト名**: `{output_target_name}` （例: `se_filtered`, `norm_se`）
- **出力される SE オブジェクトの期待状態**:
  - **新たに追加/変更される assays**: [追加・変更される assay を記述]
  - **新たに追加/変更される colData**: [追加・変更される colData 列を記述]
  - **新たに追加/変更される rowData**: [追加・変更される rowData 列を記述]
  - **新たに追加/変更される metadata**: [追加・変更される metadata を記述]

### 生成ファイル
- **プロット**:
  - `results/{experiment_id}/plots/{プロット名}.{拡張子}` （例: `results/ExpA/plots/pca_normalized.png`）
  - [生成するプロットの説明と命名規則を記述]
  - プロットは `theme_classic()` を基本とし、タイトルは中央寄せで、テキストはすべて英語
  - 基本はPNG形式、大きなヒートマップはPDF、対話的プロットはHTML
  - 解像度は300dpi以上を推奨
- **テーブル**:
  - `results/{experiment_id}/tables/{テーブル名}.{拡張子}` （例: `results/ExpA/tables/filtered_counts.csv`）
  - [生成するテーブルの説明と命名規則を記述]
- **レポート**:
  - `results/{experiment_id}/reports/{module_name}.html` (HTMLレポート)
  - `results/{experiment_id}/reports/{module_name}.md` (Markdownレポート、HTMLと共に生成)
  - **出力形式**: `_targets.R`で定義された共通出力設定が適用されます（目次、浮動目次、コード折りたたみなど）
  - 特別な出力設定が必要な場合はここに記述（標準設定を上書きする場合）

## レポート要件
- **出力形式**:
  - このモジュールは`_targets.R`で定義された以下の標準出力設定を使用します:
    - 目次あり (`toc = TRUE`)
    - 浮動目次あり (`toc_float = TRUE`)
    - コード折りたたみ (`code_folding = "hide"`)
    - Markdownファイルも保持 (`keep_md = TRUE`)
  - [標準設定と異なる出力要件がある場合はここに記述]
- **含めるべき図表**:
  - [レポートに含めるべき図表を記述]
- **含めるべき統計情報**:
  - [レポートに含めるべき統計情報を記述]
- **テキスト概要**:
  - [レポートに含めるべき説明文のポイントを記述]

## テスト要件
- **テストファイル**: `tests/test-{module_name}.R`
- **テスト方法**: `testrmd`パッケージを使用
- **テスト内容**:
  - 入力SEオブジェクトに対する処理の正確性
  - 出力SEオブジェクトの期待状態の検証
  - エラーハンドリングのテスト
- **テスト実装手順**:
  1. Red: 失敗するテストコードを記述
  2. Green: テストをパスする最小限のコードを実装
  3. Refactor: コードを最適化

## その他
- **エラーハンドリング**:
  - [特別なエラー処理が必要な場合に記述]
- **特別な制約**:
  - [特別な制約や注意点があれば記述]
- **注意事項**:
  - ファイルパスは絶対パス (`fs::path_abs()`) で指定
  - コード内のコメントは日本語で記述
  - `sessionInfo()` の情報をレポートに含める 