# R Markdownとtargetsを用いたRNA-seq解析パイプライン構築ガイドライン (AI 指針)

## 1. 基本方針: `targets` による自動化と再現性
このガイドラインは、RNA-seq解析のための**R Markdown (Rmd) モジュール**と **`targets` パッケージ**を用いたパイプラインをAI (あなた) が構築する際の**共通ルール**です。あなたは、このルールと個別の**モジュール仕様書**に基づき、再現性と効率性の高いパイプライン定義ファイル (`_targets.R`) と Rmd モジュールを作成します。

**最重要原則:**
- パイプライン全体の制御は `targets` で行う。
- 解析ステップは Rmd モジュールとして実装する (`tar_render` を利用)。
- データフローの中心は `SummarizedExperiment` (SE) オブジェクトとする。
- SE オブジェクトのメタデータ (`metadata()`) に解析履歴を記録し、パイプライン制御に活用する。

推奨ディレクトリ構成: [`project_dir.md`](project_dir.md) 参照。

## 2. データフロー: SE オブジェクトと `targets`
- **入力:**
    - **最初のモジュール (SE オブジェクト作成):** `counts.csv` や `sample_metadata.csv` 等を入力とし、SE オブジェクトを生成するターゲットを定義する。
    - **後続モジュール:** 前のステップで生成/更新された SE オブジェクトを**入力ターゲット**とする。
- **処理:** 各モジュールは入力 SE オブジェクトを受け取り、解析処理を行い、更新された SE オブジェクトを**出力ターゲット**として返す。
- **メタデータ記録:** 各モジュールは、実行した主要な処理内容、パラメータ、完了日時などを **`metadata(se)$pipeline_history`** のようなリスト構造に追記する。これは `targets` の依存関係とは別に、オブジェクト自体に処理履歴を持たせるため。
- **パイプライン制御:** `_targets.R` 内で、ターゲット定義の際に SE オブジェクトのメタデータ情報を条件分岐 (`if` 文など) に利用することを検討する (例: 特定のアノテーションが付与されている場合のみ実行)。

## 3. コーディング規約 (`_targets.R` と Rmd)
- **`_targets.R`:**
    - パイプライン全体を定義する。
    - 各解析ステップ（Rmd レンダリングや関数実行）を **ターゲット** として定義する。
    - ターゲット名は内容を反映する (例: `se_filtered`, `report_qc`)。
    - パラメータは `_targets.R` 上部で管理するか、別ファイル (YAML 等) から読み込む。
    - SE オブジェクトのメタデータに基づく条件付き実行ロジックを記述可能。
- **Rmd モジュール:**
    - `tar_load()` や `tar_read()` で入力ターゲット (主に SE オブジェクト) を読み込む。
    - `params` を介して `_targets.R` から渡されたパラメータを利用する。
    - チャンクの冒頭に目的を記述。
    - 複雑な処理やパラメータ選択理由にコメントを追加。
    - SE オブジェクトのメタデータ更新処理を必ず含める。
    - `cli` でユーザー向けメッセージ、`futile.logger` で詳細ログ出力 (任意)。
- **共通関数:** 再利用可能な関数は `src/utils.R` 等に定義し、`_targets.R` 内で `source()` するか、ターゲット定義内で呼び出す。関数の仕様は `utility.md` で管理。

## 4. スタイルとテスト
- **スタイル:** Tidyverse スタイル + Bioconductor コーディング規約。
- **テスト (TDD):** 共通関数や複雑な解析ロジックなど、テスト駆動開発が推奨される関数を実装する際は、以下の **Red-Green-Refactor サイクル**を厳守してください:
    1.  **Red:** まず失敗する最小限のテストコードを `testthat` で記述します。
    2.  **Green:** そのテストをパスする最小限のプロダクションコードを実装します。
    3.  **Refactor:** テストが通る状態を維持しつつ、コードをリファクタリングします。
    - テスト記述には `testthat::test_that()` と `expect_*()` 関数を使用します。

## 5. 再現性とパッケージ管理
- **再現性:** `targets` が依存関係とキャッシュを管理し、再現性を担保する。
- **パッケージ管理:** `renv` を使用する。`renv::snapshot()` で `renv.lock` を更新。`_targets.R` や Rmd の冒頭で必要な `library()` を記述。`sessionInfo()` は `tar_render` で生成されるレポートに含める。

## 6. モジュール仕様書 (AI 向け指示)
各モジュール作成を指示する際は、以下の**ターゲット定義情報**を含む**仕様書**を提示してください。
- **ターゲット名:** (例: `01_qc_filtering`, `se_normalized`)
- **目的:** このターゲットがパイプラインで果たす役割。
- **入力ターゲット:**
    - 依存するターゲット名。
    - 期待される入力 SE オブジェクトの状態 (必要な assays, colData, rowData, **metadata 内の履歴情報**)。
    - その他の入力ファイルやパラメータ。
- **実行コマンド/処理:**
    - Rmd ファイルのレンダリング (`tar_render`) か、関数の実行か。
    - 主要な処理ステップ、アルゴリズム、主要パッケージ/関数。
    - 使用する主要パラメータ (デフォルト値、ユーザー変更可否)。
    - **SE オブジェクトのメタデータ更新ロジック**。
- **出力ターゲット:**
    - 生成されるオブジェクト名 (主に更新された SE オブジェクト)。
    - **更新後の SE オブジェクトの期待される状態** (追加/変更される assays, colData, rowData, **metadata の追記内容**)。
    - 生成されるファイル (プロット、テーブル) のリスト、命名規則、保存場所。
- **レポート要件 (Rmd の場合):** 含めるべき図表、統計情報、テキスト概要。
  - デフォルトの出力形式は HTML とする (`tar_render` の `output_format` 引数で指定)。必要に応じて PDF 等に変更可能。
- **その他:** エラーハンドリング、特別な制約など。

## 7. パイプライン構成 (`_targets.R`)
- **モジュール実行順序:** `_targets.R` 内のターゲット間の依存関係で定義する。Rmd ファイル名のプレフィックス (`01_`, `02_`) は可読性の補助として使用可。
- **パイプラインの柔軟性:** `_targets.R` を修正することで、モジュールの組み合わせ変更や条件分岐による実行制御を行う。

## 8. 可視化とレポート
- **標準:** `ggplot2`