# スクリプト仕様書: R/generate_vis_png.R

## 1. スクリプト名
`R/generate_vis_png.R`

## 2. 目的
`targets` パイプラインの依存関係グラフ (`targets::tar_visnetwork()` の結果) を PNG 画像ファイルとして保存する。主に `_targets.R` 内から `system()` や `processx::run()` 等で呼び出されることを想定する。

## 3. 入力
### 3.1. コマンドライン引数
- `--output <ファイル名>`: **必須**。出力する PNG 画像のファイルパスを指定する。
- `key=value ...`: 任意。`targets::tar_visnetwork()` 関数に渡す追加の引数を `キー=値` の形式で指定する (例: `targets_only=TRUE`, `label="name"`)。

### 3.2. 環境
- `targets` パイプラインのメタデータ (`_targets/` ディレクトリ) がカレントディレクトリまたはアクセス可能な場所に存在すること。
- `chromote` パッケージが利用可能な Chromium/Chrome ブラウザがインストールされ、アクセス可能であること。
- 必要な R パッケージ (`targets`, `visNetwork`, `webshot2`, `chromote`) がインストールされていること。

## 4. 実行処理
1. コマンドライン引数を解析する。
   - `--output` 引数を必須とし、その値を取得する。
   - 残りの引数を `targets::tar_visnetwork()` のオプションとして解釈する。
2. 必要な R パッケージ (`targets`, `visNetwork`, `webshot2`, `chromote`) をロードする。
3. `targets::tar_visnetwork()` を、解析されたオプション引数を渡して実行する。
   - 実行に失敗した場合はエラーメッセージを出力し、ステータスコード 1 で終了する。
4. `tar_visnetwork()` が返した `visNetwork` オブジェクトを一時的な HTML ファイル (`tempfile()`) に保存する。
   - 保存に失敗した場合はエラーメッセージを出力し、ステータスコード 1 で終了する。
5. `chromote::ChromoteSession` を初期化する。
   - 初期化に失敗した場合はエラーメッセージを出力し、ステータスコード 1 で終了する。
6. `chromote` を使用して一時 HTML ファイルを開き、PNG 画像としてスクリーンショットを取得する。
   - ページの読み込みタイムアウト (60秒) やスクリーンショット取得時のエラーを検出し、失敗した場合はエラーメッセージを出力してステータスコード 1 で終了する。
   - スクリーンショットは `--output` で指定されたファイルパスに保存される。
7. `chromote::ChromoteSession` を閉じる。
8. 処理の主要なステップやエラー発生時に、標準出力にメッセージを出力する (簡易的なログとして機能)。
9. 正常に完了した場合、ステータスコード 0 で終了する。

## 5. 出力
### 5.1. ファイル
- `--output` 引数で指定されたパスに、`targets` の依存関係グラフを描画した PNG ファイルが生成される。

### 5.2. 標準出力/標準エラー出力
- スクリプトの実行状況を示すメッセージ（引数、HTML保存先、`chromote` の初期化、スクリーンショットの実行、成功/失敗など）。
- エラー発生時の詳細なエラーメッセージ。

### 5.3. 終了ステータスコード
- 正常終了: `0`
- 異常終了: `1`

## 6. 注意点・前提条件
- このスクリプトは単独で実行されることを想定しており、`targets` パイプラインのターゲットとして直接定義されるものではない (`tar_script()` などでの利用は可能)。
- `chromote` はヘッドレスブラウザ (Chromium/Chrome) を必要とするため、実行環境にインストールされている必要がある。
- `tar_visnetwork()` のオプションは、スペースを含む値や特殊文字を含む場合は適切にクォートまたはエスケープしてコマンドライン引数として渡す必要がある (例: `label="name and status"`)。
- ネットワークのレンダリング時間によっては、スクリプト内の `Sys.sleep()` や `chromote` のタイムアウト調整が必要になる場合がある。 